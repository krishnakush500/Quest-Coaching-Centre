<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Coaching - Online Test Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ===== GLOBAL STYLES ===== */
        :root {
            --primary-green: #2E7D32;
            --light-green: #4CAF50;
            --dark-green: #1B5E20;
            --primary-red: #D32F2F;
            --light-red: #EF5350;
            --dark-red: #C62828;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #616161;
            --text-color: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== HEADER / COACHING DETAILS ===== */
        .coaching-header {
            background: linear-gradient(to right, var(--primary-green), var(--dark-green));
            color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .coaching-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .coaching-header .details {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .coaching-header .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .coaching-header .detail-item i {
            font-size: 1.1rem;
        }

        /* ===== CARDS ===== */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-green);
        }

        .test-card {
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .test-card:hover {
            transform: translateY(-5px);
            border-left-color: var(--light-green);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--dark-green);
        }

        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--dark-gray);
            color: var(--white);
        }

        .btn-danger {
            background-color: var(--primary-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: var(--dark-red);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* ===== TEST LIST ===== */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .test-title {
            font-size: 1.4rem;
            color: var(--primary-green);
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .test-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .test-detail i {
            color: var(--primary-green);
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        /* ===== TEST SCREEN ===== */
        .test-header {
            background-color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .test-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .test-name {
            font-size: 1.5rem;
            color: var(--primary-green);
            font-weight: 600;
        }

        .student-info {
            color: var(--dark-gray);
            font-size: 0.95rem;
        }

        .timer-container {
            background-color: var(--light-red);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.2rem;
            min-width: 120px;
            text-align: center;
        }

        .timer-warning {
            background-color: var(--primary-red);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ===== QUESTION CARD ===== */
        .question-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .question-number {
            font-size: 1.1rem;
            color: var(--primary-green);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.7;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background-color: var(--light-gray);
            border-color: var(--primary-green);
        }

        .option.selected {
            background-color: rgba(76, 175, 80, 0.1);
            border-color: var(--primary-green);
        }

        .option input {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .option-label {
            font-weight: 600;
            margin-right: 10px;
            color: var(--primary-green);
        }

        /* ===== TEST NAVIGATION ===== */
        .test-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .question-progress {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark-gray);
            font-weight: 600;
        }

        /* ===== RESULT SCREEN ===== */
        .result-screen {
            background-color: white;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .result-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: center;
        }

        .result-print-area {
            background-color: white;
            border: 2px solid var(--primary-green);
            border-radius: 10px;
            padding: 20px;
            margin: 0 auto;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .coaching-info {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary-green);
            padding-bottom: 15px;
        }

        .coaching-name {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .coaching-location {
            font-size: 1rem;
            color: var(--dark-gray);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .coaching-details {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .coaching-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ceo-info {
            background-color: rgba(46, 125, 50, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: 600;
        }

        .result-title {
            text-align: center;
            font-size: 1.5rem;
            color: var(--primary-red);
            margin-bottom: 20px;
            padding: 8px;
            background-color: rgba(211, 47, 47, 0.1);
            border-radius: 5px;
        }

        .student-info-result {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .student-info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed var(--medium-gray);
        }

        .student-info-item:last-child {
            border-bottom: none;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }

        .result-table th {
            background-color: var(--primary-green);
            color: var(--white);
            padding: 12px;
            text-align: left;
            font-size: 1rem;
        }

        .result-table td {
            padding: 12px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table .highlight {
            font-weight: bold;
            color: var(--primary-green);
        }

        .result-table .wrong {
            color: var(--primary-red);
            font-weight: bold;
        }

        .result-status {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .first-division {
            background-color: rgba(46, 125, 50, 0.2);
            color: var(--primary-green);
            border: 3px solid var(--primary-green);
        }

        .second-division {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FF8F00;
            border: 3px solid #FF8F00;
        }

        .third-division {
            background-color: rgba(33, 150, 243, 0.2);
            color: #1976D2;
            border: 3px solid #1976D2;
        }

        .fail-status {
            background-color: rgba(211, 47, 47, 0.15);
            color: var(--primary-red);
            border: 3px solid var(--primary-red);
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--medium-gray);
            flex-wrap: wrap;
        }

        .result-footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: var(--dark-gray);
            font-size: 0.8rem;
            border-top: 1px solid var(--medium-gray);
        }

        /* ===== LOADING & MESSAGES ===== */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--dark-gray);
        }

        .loading i {
            color: var(--primary-green);
            margin-right: 10px;
        }

        .error-message {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--primary-red);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
        }

        .success-message {
            background-color: rgba(46, 125, 50, 0.1);
            color: var(--primary-green);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--dark-gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--medium-gray);
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .result-screen,
            .result-screen * {
                visibility: visible;
            }
            
            .result-screen {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .result-print-area {
                border: none;
                box-shadow: none;
                padding: 20px;
                margin: 0;
                max-width: 100%;
                page-break-inside: avoid;
            }
            
            .result-actions,
            .result-footer {
                display: none !important;
            }
        }

        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 768px) {
            .coaching-header .details {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .tests-grid {
                grid-template-columns: 1fr;
            }

            .test-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .timer-container {
                align-self: center;
            }

            .student-info-result {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
            }

            .test-navigation {
                flex-direction: column;
            }

            .test-navigation .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .coaching-name {
                font-size: 1.5rem;
            }
            
            .coaching-location {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
            
            .coaching-details {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                font-size: 0.85rem;
            }
            
            .ceo-info {
                font-size: 0.85rem;
                padding: 8px;
            }
            
            .result-print-area {
                padding: 15px;
                border-width: 1px;
            }
            
            .result-table th,
            .result-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            
            .result-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .result-actions .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .result-status {
                font-size: 1.3rem;
                padding: 12px;
                margin: 10px 0;
                min-height: 50px;
            }
            
            .result-container {
                padding: 10px;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .coaching-header h1 {
                font-size: 1.5rem;
            }

            .test-name {
                font-size: 1.3rem;
            }
            
            .coaching-name {
                font-size: 1.3rem;
            }
            
            .coaching-location {
                font-size: 0.85rem;
            }
            
            .coaching-details {
                font-size: 0.8rem;
            }
            
            .result-title {
                font-size: 1.3rem;
            }
            
            .result-print-area {
                padding: 12px;
                border: 1px solid var(--primary-green);
                box-shadow: 0 0 10px rgba(0,0,0,0.05);
            }
            
            .result-table {
                font-size: 0.85rem;
            }
            
            .student-info-result {
                font-size: 0.85rem;
            }
        }
        
        /* Mobile result screen optimization - NO SCROLL */
        @media (max-height: 800px) and (max-width: 768px) {
            .result-print-area {
                padding: 12px;
                margin: 5px auto;
                transform: scale(0.85);
                transform-origin: top center;
            }
            
            .coaching-info {
                margin-bottom: 10px;
                padding-bottom: 8px;
            }
            
            .coaching-name {
                font-size: 1.3rem;
                margin-bottom: 5px;
            }
            
            .coaching-location {
                font-size: 0.8rem;
                margin-bottom: 8px;
            }
            
            .coaching-details {
                font-size: 0.8rem;
                gap: 8px;
                margin-top: 5px;
            }
            
            .result-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
                padding: 6px;
            }
            
            .student-info-result {
                padding: 10px;
                margin-bottom: 12px;
                font-size: 0.8rem;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .result-status {
                font-size: 1.1rem;
                padding: 10px;
                margin: 10px 0;
                min-height: 45px;
            }
            
            .result-actions {
                margin-top: 15px;
                padding-top: 15px;
            }
            
            .result-footer {
                margin-top: 15px;
                padding: 10px;
                font-size: 0.75rem;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-height: 600px) {
            .result-print-area {
                transform: scale(0.75);
                margin-top: -10px;
            }
        }
        
        /* Hide result card template on other pages */
        .page:not(#page-result) .result-print-area {
            display: none;
        }
        
        /* Compact card for mobile */
        .compact-card {
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Page 1: Test List -->
    <div id="page-test-list" class="page active">
        <div class="container">
            <div class="coaching-header">
                <h1>QUEST COACHING CENTRE</h1>
                <p>In Front of S.S. Girls High School, Gopalganj</p>
                <div class="details">
                    <div class="detail-item">
                        <i class="fas fa-user-tie"></i>
                        <span>CEO & FOUNDER: MR. RAVI SIR</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>Call: +91 9708442525</span>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2>Available Tests</h2>
                <p>Select a test to begin your examination.</p>
            </div>

            <div id="tests-container" class="tests-grid">
                <!-- Tests will be loaded here -->
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading available tests...
                </div>
            </div>

            <div class="footer">
                <p>QUEST COACHING CENTRE &copy; 2024</p>
            </div>
        </div>
    </div>

    <!-- Page 2: Student Details -->
    <div id="page-student-details" class="page">
        <div class="container">
            <div class="coaching-header">
                <h1>QUEST COACHING CENTRE</h1>
                <p>In Front of S.S. Girls High School, Gopalganj</p>
                <div class="details">
                    <div class="detail-item">
                        <i class="fas fa-user-tie"></i>
                        <span>CEO & FOUNDER: MR. RAVI SIR</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>Call: +91 9708442525</span>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2>Student Registration</h2>
                <p>Please enter your details to proceed with the test.</p>
                
                <form id="student-form">
                    <div class="form-group">
                        <label for="student-name" class="form-label">Full Name *</label>
                        <input type="text" id="student-name" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="roll-number" class="form-label">Roll Number *</label>
                        <input type="text" id="roll-number" class="form-control" placeholder="Enter your roll number" required>
                    </div>
                    
                    <div id="student-form-error" class="error-message" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Proceed to Test</button>
                    <button type="button" id="back-to-tests" class="btn btn-secondary btn-block" style="margin-top: 10px;">Back to Test List</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Page 3: Test Screen -->
    <div id="page-test-screen" class="page">
        <div class="container">
            <div class="test-header">
                <div class="test-info">
                    <div class="test-name" id="current-test-name">Test Name</div>
                    <div class="student-info">
                        <span id="display-student-name">Student Name</span> | 
                        <span id="display-roll-number">Roll Number</span>
                    </div>
                </div>
                <div class="timer-container" id="timer">
                    30:00
                </div>
            </div>

            <div class="question-progress" id="question-progress">
                Question 1 of 30
            </div>

            <div class="question-container">
                <div class="question-number" id="question-number">Question 1</div>
                <div class="question-text" id="question-text">
                    Loading question...
                </div>
                
                <div class="options-container" id="options-container">
                    <!-- Options will be loaded here -->
                </div>
            </div>

            <div class="test-navigation">
                <button id="prev-question" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button id="next-question" class="btn btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="complete-test" class="btn btn-danger">
                    <i class="fas fa-paper-plane"></i> Complete Test
                </button>
            </div>
        </div>
    </div>

    <!-- Page 4: Result Screen -->
    <div id="page-result" class="page result-screen">
        <div class="result-container">
            <div id="result-print-area" class="result-print-area">
                <!-- Coaching Info -->
                <div class="coaching-info">
                    <div class="coaching-name">QUEST COACHING CENTRE</div>
                    <div class="coaching-location">
                        In Front of S.S. Girls High School, Gopalganj
                    </div>
                    <div class="coaching-details">
                        <div class="coaching-detail ceo-info">
                            <i class="fas fa-user-tie"></i>
                            <span>CEO & FOUNDER: MR. RAVI SIR</span>
                        </div>
                        <div class="coaching-detail">
                            <i class="fas fa-phone"></i>
                            <span>Call: +91 9708442525</span>
                        </div>
                    </div>
                </div>
                
                <!-- Result Title -->
                <div class="result-title">
                    <i class="fas fa-award"></i> EXAMINATION RESULT
                </div>
                
                <!-- Student Info -->
                <div class="student-info-result">
                    <div class="student-info-item">
                        <strong>Student Name:</strong>
                        <span id="result-student-name">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Roll Number:</strong>
                        <span id="result-roll-number">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Test Name:</strong>
                        <span id="result-test-name">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Date:</strong>
                        <span id="result-test-date">-</span>
                    </div>
                </div>
                
                <!-- Result Table -->
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Questions</td>
                            <td id="total-questions">0</td>
                        </tr>
                        <tr>
                            <td>Attempted</td>
                            <td id="attempted-questions">0</td>
                        </tr>
                        <tr>
                            <td>Correct Answers</td>
                            <td id="correct-answers" class="highlight">0</td>
                        </tr>
                        <tr>
                            <td>Wrong Answers</td>
                            <td id="wrong-answers" class="wrong">0</td>
                        </tr>
                        <tr>
                            <td>Total Marks</td>
                            <td id="total-marks">0</td>
                        </tr>
                        <tr>
                            <td>Marks Obtained</td>
                            <td id="marks-obtained" class="highlight">0</td>
                        </tr>
                        <tr>
                            <td>Percentage</td>
                            <td id="percentage" class="highlight">0%</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Result Status -->
                <div id="result-status" class="result-status">
                    <!-- Division status will be shown here -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="result-actions">
                <button id="download-pdf" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button id="print-result" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print Result
                </button>
                <button id="new-test" class="btn btn-danger">
                    <i class="fas fa-plus"></i> Take Another Test
                </button>
            </div>
            
            <div class="result-footer">
                <p>This is an electronically generated result. No signature required.</p>
                <p>QUEST COACHING CENTRE &copy; 2024 | Result ID: <span id="result-id">-</span></p>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBoAqrgPwwM7GNyURqXrJEYWPihKKR8VGg",
            authDomain: "quest-coaching.firebaseapp.com",
            projectId: "quest-coaching",
            storageBucket: "quest-coaching.firebasestorage.app",
            messagingSenderId: "131948734089",
            appId: "1:131948734089:web:f4ba25110c8b1298360858"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===== GLOBAL VARIABLES =====
        let currentPage = 'test-list';
        let tests = [];
        let currentTest = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let timerInterval = null;
        let timeRemaining = 0;
        let studentDetails = {};
        let resultId = '';

        // ===== PAGE NAVIGATION FUNCTIONS =====
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show requested page
            document.getElementById(`page-${pageId}`).classList.add('active');
            currentPage = pageId;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // ===== PAGE 1: TEST LIST =====
        async function loadTests() {
            const container = document.getElementById('tests-container');
            
            try {
                const snapshot = await db.collection('tests')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                tests = [];
                snapshot.forEach(doc => {
                    tests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                displayTests();
            } catch (error) {
                console.error('Error loading tests:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading tests. Please check your internet connection and try again.
                    </div>
                `;
            }
        }

        function displayTests() {
            const container = document.getElementById('tests-container');
            
            if (tests.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <h3>No Tests Available</h3>
                        <p>There are no published tests at the moment. Please check back later.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tests.map(test => `
                <div class="card test-card" data-test-id="${test.id}">
                    <h3 class="test-title">${test.testName || 'Unnamed Test'}</h3>
                    <div class="test-details">
                        <div class="test-detail">
                            <i class="fas fa-question-circle"></i>
                            <span>${test.totalQuestions || 0} Questions</span>
                        </div>
                        <div class="test-detail">
                            <i class="fas fa-star"></i>
                            <span>${test.totalMarks || 0} Marks</span>
                        </div>
                        <div class="test-detail">
                            <i class="fas fa-clock"></i>
                            <span>${test.duration || 30} Minutes</span>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block start-test" data-test-id="${test.id}">
                        Start Test
                    </button>
                </div>
            `).join('');
            
            // Add event listeners to start test buttons
            document.querySelectorAll('.start-test').forEach(button => {
                button.addEventListener('click', function() {
                    const testId = this.getAttribute('data-test-id');
                    startTest(testId);
                });
            });
        }

        function startTest(testId) {
            currentTest = tests.find(test => test.id === testId);
            if (!currentTest) {
                alert('Test not found!');
                return;
            }
            
            // Reset answers
            studentAnswers = {};
            currentQuestionIndex = 0;
            
            showPage('student-details');
        }

        // ===== PAGE 2: STUDENT DETAILS =====
        document.getElementById('student-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('student-name').value.trim();
            const rollNumber = document.getElementById('roll-number').value.trim();
            const errorDiv = document.getElementById('student-form-error');
            
            // Validation
            if (!studentName || !rollNumber) {
                errorDiv.textContent = 'Please fill in all required fields.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (studentName.length < 2) {
                errorDiv.textContent = 'Please enter a valid name.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Check if roll number already attempted this test
            try {
                const resultSnapshot = await db.collection('onlinetestresults')
                    .where('testId', '==', currentTest.id)
                    .where('rollNumber', '==', rollNumber)
                    .get();
                
                if (!resultSnapshot.empty) {
                    errorDiv.textContent = 'This roll number has already attempted this test. Each roll number can attempt only once.';
                    errorDiv.style.display = 'block';
                    return;
                }
            } catch (error) {
                console.error('Error checking existing attempts:', error);
            }
            
            // Save student details
            studentDetails = {
                name: studentName,
                rollNumber: rollNumber
            };
            
            // Proceed to test screen
            loadTestQuestions();
        });

        document.getElementById('back-to-tests').addEventListener('click', function() {
            showPage('test-list');
        });

        // ===== PAGE 3: TEST SCREEN =====
        async function loadTestQuestions() {
            if (!currentTest || !currentTest.questionsText) {
                alert('Test questions not found!');
                showPage('test-list');
                return;
            }
            
            try {
                // Parse questions from the questionsText field
                currentQuestions = parseQuestions(currentTest.questionsText);
                
                // Display test info
                document.getElementById('current-test-name').textContent = currentTest.testName;
                document.getElementById('display-student-name').textContent = studentDetails.name;
                document.getElementById('display-roll-number').textContent = studentDetails.rollNumber;
                
                // Initialize timer
                const duration = currentTest.duration || 30;
                timeRemaining = duration * 60; // Convert to seconds
                
                // Start the timer
                startTimer();
                
                // Show first question
                showQuestion(0);
                
                // Show test screen
                showPage('test-screen');
                
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading test questions. Please try another test.');
                showPage('test-list');
            }
        }

        function parseQuestions(questionsText) {
            const questions = [];
            const lines = questionsText.split('\n');
            let currentQuestion = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Check if line starts a new question
                if (line.match(/^Q\d+\./)) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    
                    currentQuestion = {
                        text: line.replace(/^Q\d+\.\s*/, ''),
                        options: [],
                        correctAnswer: ''
                    };
                }
                // Check for options (A), B), C), D))
                else if (line.match(/^[A-D]\)/)) {
                    if (currentQuestion) {
                        const option = line.substring(2).trim();
                        currentQuestion.options.push(option);
                    }
                }
                // Check for answer line
                else if (line.match(/^Answer:/i)) {
                    if (currentQuestion) {
                        currentQuestion.correctAnswer = line.replace(/^Answer:\s*/i, '').trim();
                    }
                }
                // Append to question text if it's a continuation
                else if (line && currentQuestion && !currentQuestion.correctAnswer) {
                    currentQuestion.text += ' ' + line;
                }
            }
            
            // Add the last question
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }

        function showQuestion(index) {
            if (index < 0 || index >= currentQuestions.length) {
                return;
            }
            
            currentQuestionIndex = index;
            const question = currentQuestions[index];
            
            // Update progress
            document.getElementById('question-progress').textContent = 
                `Question ${index + 1} of ${currentQuestions.length}`;
            
            document.getElementById('question-number').textContent = `Question ${index + 1}`;
            document.getElementById('question-text').textContent = question.text;
            
            // Display options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['A', 'B', 'C', 'D'];
            question.options.forEach((option, i) => {
                const optionId = `option-${index}-${i}`;
                const isSelected = studentAnswers[index] === optionLabels[i];
                
                const optionElement = document.createElement('div');
                optionElement.className = `option ${isSelected ? 'selected' : ''}`;
                optionElement.innerHTML = `
                    <input type="radio" id="${optionId}" name="question-${index}" value="${optionLabels[i]}"
                           ${isSelected ? 'checked' : ''}>
                    <span class="option-label">${optionLabels[i]})</span>
                    <label for="${optionId}">${option}</label>
                `;
                
                // Add event listener
                optionElement.addEventListener('click', function() {
                    selectOption(index, optionLabels[i]);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // Update button states
            document.getElementById('prev-question').disabled = index === 0;
            document.getElementById('next-question').disabled = index === currentQuestions.length - 1;
        }

        function selectOption(questionIndex, option) {
            studentAnswers[questionIndex] = option;
            showQuestion(questionIndex); // Refresh to show selection
        }

        function startTimer() {
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            updateTimerDisplay();
            
            // Start new timer
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // Check if time is up
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
                
                // Add warning class when less than 5 minutes remain
                const timerElement = document.getElementById('timer');
                if (timeRemaining <= 300) { // 5 minutes = 300 seconds
                    timerElement.classList.add('timer-warning');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('timer');
            
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Navigation buttons
        document.getElementById('prev-question').addEventListener('click', function() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });

        document.getElementById('next-question').addEventListener('click', function() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });

        // Complete test button
        document.getElementById('complete-test').addEventListener('click', function() {
            if (confirm('Are you sure you want to complete the test? You cannot go back once submitted.')) {
                submitTest();
            }
        });

        // ===== TEST SUBMISSION & RESULT CALCULATION =====
        async function submitTest() {
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Calculate results
            const totalQuestions = currentQuestions.length;
            let attempted = 0;
            let correct = 0;
            
            for (let i = 0; i < totalQuestions; i++) {
                if (studentAnswers[i]) {
                    attempted++;
                    if (studentAnswers[i] === currentQuestions[i].correctAnswer) {
                        correct++;
                    }
                }
            }
            
            const wrong = attempted - correct;
            const totalMarks = currentTest.totalMarks || totalQuestions;
            const marksPerQuestion = totalMarks / totalQuestions;
            const marksObtained = correct * marksPerQuestion;
            const percentage = (marksObtained / totalMarks) * 100;
            
            // Determine Division
            let division = '';
            let statusClass = '';
            
            if (percentage >= 60) {
                division = 'FIRST DIVISION';
                statusClass = 'first-division';
            } else if (percentage >= 45) {
                division = 'SECOND DIVISION';
                statusClass = 'second-division';
            } else if (percentage >= 33) {
                division = 'THIRD DIVISION';
                statusClass = 'third-division';
            } else {
                division = 'FAIL';
                statusClass = 'fail-status';
            }
            
            const isPass = percentage >= 33;
            
            // Generate result ID
            resultId = 'RES' + Date.now() + Math.floor(Math.random() * 1000);
            
            // Store result in Firebase - NEW COLLECTION NAME
            await saveResultToFirebase({
                totalQuestions,
                attempted,
                correct,
                wrong,
                totalMarks,
                marksObtained: marksObtained.toFixed(2),
                percentage: percentage.toFixed(2),
                division,
                isPass
            });
            
            // Display results
            displayResults({
                totalQuestions,
                attempted,
                correct,
                wrong,
                totalMarks,
                marksObtained: marksObtained.toFixed(2),
                percentage: percentage.toFixed(2),
                division,
                statusClass
            });
        }

        async function saveResultToFirebase(results) {
            try {
                const resultData = {
                    studentName: studentDetails.name,
                    rollNumber: studentDetails.rollNumber,
                    testId: currentTest.id,
                    testName: currentTest.testName,
                    totalQuestions: results.totalQuestions,
                    attempted: results.attempted,
                    correct: results.correct,
                    wrong: results.wrong,
                    totalMarks: results.totalMarks,
                    marksObtained: parseFloat(results.marksObtained),
                    percentage: parseFloat(results.percentage),
                    division: results.division,
                    isPass: results.isPass,
                    answers: studentAnswers,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    resultId: resultId
                };
                
                // SAVE TO NEW COLLECTION: onlinetestresults
                await db.collection('onlinetestresults').add(resultData);
                console.log('Result saved to onlinetestresults collection');
            } catch (error) {
                console.error('Error saving result to Firebase:', error);
                // Continue to show result even if saving fails
            }
        }

        function displayResults(results) {
            // Set student and test info
            document.getElementById('result-student-name').textContent = studentDetails.name;
            document.getElementById('result-roll-number').textContent = studentDetails.rollNumber;
            document.getElementById('result-test-name').textContent = currentTest.testName;
            document.getElementById('result-test-date').textContent = new Date().toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            document.getElementById('result-id').textContent = resultId;
            
            // Set result values
            document.getElementById('total-questions').textContent = results.totalQuestions;
            document.getElementById('attempted-questions').textContent = results.attempted;
            document.getElementById('correct-answers').textContent = results.correct;
            document.getElementById('wrong-answers').textContent = results.wrong;
            document.getElementById('total-marks').textContent = results.totalMarks;
            document.getElementById('marks-obtained').textContent = results.marksObtained;
            document.getElementById('percentage').textContent = `${results.percentage}%`;
            
            // Set division status
            const statusElement = document.getElementById('result-status');
            statusElement.className = `result-status ${results.statusClass}`;
            
            if (results.division === 'FAIL') {
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> FAIL <i class="fas fa-times-circle"></i>';
            } else {
                statusElement.innerHTML = `<i class="fas fa-trophy"></i> ${results.division} <i class="fas fa-trophy"></i>`;
            }
            
            // Show result page
            showPage('result');
            
            // Adjust result display for mobile
            setTimeout(() => {
                adjustResultForMobile();
            }, 100);
        }

        function adjustResultForMobile() {
            if (window.innerWidth <= 768) {
                const printArea = document.getElementById('result-print-area');
                const container = document.querySelector('.result-container');
                const printAreaHeight = printArea.offsetHeight;
                const viewportHeight = window.innerHeight;
                const actionHeight = document.querySelector('.result-actions').offsetHeight;
                const footerHeight = document.querySelector('.result-footer').offsetHeight;
                
                // Calculate available height for result
                const availableHeight = viewportHeight - actionHeight - footerHeight - 40; // 40px for padding
                
                if (printAreaHeight > availableHeight) {
                    // Scale down to fit
                    const scale = availableHeight / printAreaHeight;
                    printArea.style.transform = `scale(${Math.min(scale, 0.85)})`;
                    printArea.style.transformOrigin = 'top center';
                    printArea.style.marginTop = '5px';
                } else {
                    printArea.style.transform = 'scale(1)';
                    printArea.style.transformOrigin = 'top center';
                    printArea.style.marginTop = '0';
                }
            }
        }

        // ===== RESULT PAGE BUTTONS =====
        document.getElementById('download-pdf').addEventListener('click', async function() {
            await downloadResultAsPDF();
        });

        document.getElementById('print-result').addEventListener('click', function() {
            window.print();
        });

        document.getElementById('new-test').addEventListener('click', function() {
            // Reset state
            currentTest = null;
            currentQuestions = [];
            currentQuestionIndex = 0;
            studentAnswers = {};
            studentDetails = {};
            
            // Clear form
            document.getElementById('student-form').reset();
            
            // Return to test list
            showPage('test-list');
        });

        // ===== PDF DOWNLOAD FUNCTION =====
        async function downloadResultAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const printArea = document.getElementById('result-print-area');
            
            // Show loading
            const downloadBtn = document.getElementById('download-pdf');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            downloadBtn.disabled = true;
            
            try {
                // Temporarily adjust for PDF generation
                const originalTransform = printArea.style.transform;
                const originalMarginTop = printArea.style.marginTop;
                
                // Reset transform for PDF generation
                printArea.style.transform = 'none';
                printArea.style.marginTop = '0';
                
                // Create a clone for PDF generation
                const clone = printArea.cloneNode(true);
                clone.style.width = '700px';
                clone.style.padding = '30px';
                clone.style.fontSize = '14px';
                clone.style.border = '2px solid #2E7D32';
                clone.style.borderRadius = '10px';
                
                // Add clone to body temporarily
                clone.style.position = 'fixed';
                clone.style.left = '-10000px';
                clone.style.top = '0';
                clone.style.zIndex = '-1000';
                document.body.appendChild(clone);
                
                // Use html2canvas with better options for PDF
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    backgroundColor: '#FFFFFF',
                    useCORS: true,
                    logging: false,
                    width: 700,
                    height: clone.scrollHeight,
                    windowWidth: 700
                });
                
                // Remove clone
                document.body.removeChild(clone);
                
                // Restore original transform
                printArea.style.transform = originalTransform;
                printArea.style.marginTop = originalMarginTop;
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190; // A4 width in mm (210mm - 20mm margins)
                const pageHeight = 277; // A4 height in mm (297mm - 20mm margins)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Check if image fits on one page
                if (imgHeight > pageHeight) {
                    // Scale down to fit on one page
                    const scale = pageHeight / imgHeight;
                    const scaledWidth = imgWidth * scale * 0.95;
                    const scaledHeight = imgHeight * scale * 0.95;
                    
                    // Center on page
                    const xPos = (210 - scaledWidth) / 2;
                    const yPos = (297 - scaledHeight) / 2;
                    
                    pdf.addImage(imgData, 'PNG', xPos, yPos, scaledWidth, scaledHeight);
                } else {
                    // Center vertically
                    const yPos = (pageHeight - imgHeight) / 2;
                    pdf.addImage(imgData, 'PNG', 10, yPos, imgWidth, imgHeight);
                }
                
                // Add footer
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text('This is an electronically generated result. No signature required.', 105, 287, { align: 'center' });
                pdf.text(`Result ID: ${resultId} | Generated on: ${new Date().toLocaleDateString()}`, 105, 292, { align: 'center' });
                
                // Save the PDF
                pdf.save(`Result_${studentDetails.rollNumber}_${resultId}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. You can use the Print button instead.');
            } finally {
                // Restore button
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }

        // ===== INITIALIZE APP =====
        document.addEventListener('DOMContentLoaded', function() {
            // Load tests on initial page load
            loadTests();
            
            // Set up keyboard navigation for test screen
            document.addEventListener('keydown', function(e) {
                if (currentPage === 'test-screen') {
                    if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
                        showQuestion(currentQuestionIndex - 1);
                    } else if (e.key === 'ArrowRight' && currentQuestionIndex < currentQuestions.length - 1) {
                        showQuestion(currentQuestionIndex + 1);
                    } else if (e.key >= '1' && e.key <= '4') {
                        // Select option with number keys (1-4 for A-D)
                        const optionIndex = parseInt(e.key) - 1;
                        const optionLabels = ['A', 'B', 'C', 'D'];
                        if (optionIndex < currentQuestions[currentQuestionIndex].options.length) {
                            selectOption(currentQuestionIndex, optionLabels[optionIndex]);
                        }
                    }
                }
            });
            
            // Handle window resize for mobile result display
            window.addEventListener('resize', function() {
                if (currentPage === 'result') {
                    adjustResultForMobile();
                }
            });
            
            // Initial adjustment for result page if needed
            if (currentPage === 'result') {
                setTimeout(adjustResultForMobile, 500);
            }
        });

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            
            // Show user-friendly error message
            if (currentPage === 'test-screen') {
                alert('An error occurred during the test. Your answers have been saved locally. Please contact support.');
            }
        });
    </script>
</body>
</html>
